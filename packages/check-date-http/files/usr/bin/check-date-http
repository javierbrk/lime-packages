#!/usr/bin/lua
--! SPDX-License-Identifier: AGPL-3.0-only
--! 
--! Copyright (C) 2019  Gioacchino Mazzurco <gio@altermundi.net>
--! Copyright (C) 2019  Nicolas Echaniz <nicoechaniz@altermundi.net>

local libuci = require("uci")

-- Function to get HTTP Date header using uclient-fetch
-- Returns the Date header string or nil on error
local function get_http_date(url)
	-- Build uclient-fetch command:
	-- -q: quiet mode
	-- -O -: output to stdout
	-- --header-only: fetch only headers (like HTTP HEAD)
	-- --timeout=5: 5 seconds timeout for send and receive
	-- --max-redirect=0: don't follow redirects
	local cmd = string.format(
		"uclient-fetch -q -O - --header-only --timeout=5 --max-redirect=0 '%s' 2>&1",
		url
	)

	local handle = io.popen(cmd)
	if not handle then
		return nil
	end

	local headers = handle:read("*a")
	local success, exit_type, exit_code = handle:close()

	-- Check if command executed successfully
	-- handle:close() returns: true, "exit", code on success
	if not success or exit_type ~= "exit" or exit_code ~= 0 then
		return nil
	end

	-- Parse Date header from output
	-- Look for "Date: " followed by the date string
	local date = headers:match("Date: ([^\r\n]+)")
	return date
end


local config = libuci:cursor()
local url = config:get("check-date", "http", "server")
url = url or { "http://openwrt.org" }
math.randomseed(os.time())
url = url[math.random(#url)]
local resetDate = config:get("check-date", "system", "reset_date") or false
local restartSysntpd = config:get("check-date", "system", "restart_sysntpd")
restartSysntpd = (restartSysntpd == nil) or restartSysntpd
config = nil

local localCurrDate = assert(io.popen("date --utc -Iminutes", 'r'):read())
local lFormat="(%d+)-(%d+)-(%d+)T(%d+):(%d+)UTC"
local lYear, lMonth, lDay, lHour, lMin = localCurrDate:match(lFormat)

-- Get HTTP Date header using uclient-fetch
local success, date_header = pcall(get_http_date, url)

if not success or not date_header then
	print(arg[0], "HTTP request failed", url)
	os.exit(42)
end

local s = date_header
local p="%a+, (%d+) (%a+) (%d+) (%d+):(%d+):(%d+) GMT"
local day, month, year, hour, min, sec = s:match(p)
local MON = { Jan="01", Feb="02", Mar="03", Apr="04", May="05", Jun="06", Jul="07", Aug="08", Sep="09", Oct="10", Nov="11", Dec="12"}
month = MON[month]

local skewDetected = false

local lTdate = { lYear, lMonth, lDay, lHour }
local rTdate = { year,  month,  day,  hour }

for i=1,#lTdate do
	if(lTdate[i] ~= rTdate[i]) then
		skewDetected = true
		break
	end
end

skewDetected = skewDetected or (math.abs(lMin - min) > 13)

if(skewDetected) then
	local currDate = string.format(
		"%s.%s.%s-%s:%s:%s", lYear, lMonth, lDay, lHour, lMin, "XX" )
	local newDate = string.format(
		"%s.%s.%s-%s:%s:%s", year, month, day, hour, min, sec )

	print( arg[0].." Too far away clock skew detected "..
	       " local "..currDate.." "..url.." "..newDate )

	if resetDate then
		os.execute("date --utc --set "..newDate)
	end
	if restartSysntpd then os.execute("/etc/init.d/sysntpd restart") end
end
